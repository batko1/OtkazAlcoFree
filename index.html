<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OtkazAlcoFree ‚Äî iOS‚Äë26 (Pro)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    /* ===== iOS‚Äë26 Tokens ===== */
    :root{
      --bg:#f6f7f9; --card:#fff; --glass:#ffffffb3; --text:#0b0b0c; --sub:#5c5c60;
      --accent:#34c759; /* –∑–µ–ª—ë–Ω—ã–π */
      --accent-2:#ff3b30; /* SOS */
      --hair:rgba(0,0,0,.08); --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius-xl:22px; --radius-lg:16px; --radius:12px; --dur:.28s; --easing:cubic-bezier(.22,.61,.36,1);
      --warn:#ff9f0a;
    }
    body.dark{ --bg:#000; --card:#1c1c1e; --glass:#1c1c1ecc; --text:#fff; --sub:#b9b9bd; --hair:rgba(255,255,255,.12); --shadow:0 10px 30px rgba(0,0,0,.5); --accent:#30d158; --warn:#ffd60a; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 -apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;transition:background var(--dur) var(--easing),color var(--dur) var(--easing)}

    .app{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}

    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.9rem 1.2rem;background:var(--glass);backdrop-filter:saturate(140%) blur(18px);-webkit-backdrop-filter:saturate(140%) blur(18px);border-bottom:1px solid var(--hair)}
    .title{margin:0;font-weight:800;letter-spacing:.2px;font-size:1.05rem}
    .muted{color:var(--sub);font-size:.82rem}
    .toggle{appearance:none;border:0;background:transparent;color:var(--text);width:40px;height:40px;border-radius:12px;cursor:pointer;display:grid;place-items:center;font-size:1.05rem;transition:transform .18s var(--easing),background var(--dur) var(--easing)}
    .toggle:hover{background:rgba(0,0,0,.06)}

    main{padding:1.2rem;max-width:880px;margin:0 auto;display:grid;gap:1rem}
    .card{background:var(--card);border-radius:22px;box-shadow:var(--shadow);border:1px solid var(--hair);padding:1.1rem 1.2rem}

    .row{display:grid;gap:1rem;grid-template-columns:1fr 1fr}
    .row-3{display:grid;gap:.9rem;grid-template-columns:repeat(3,1fr)}

    .label{font-size:.8rem;color:var(--sub);margin-bottom:.35rem}
    .segmented{display:flex;gap:.4rem;background:var(--bg);border:1px solid var(--hair);border-radius:999px;padding:.25rem}
    .segmented button{flex:1;appearance:none;border:0;background:transparent;color:var(--text);padding:.5rem .8rem;border-radius:999px;font-weight:700;cursor:pointer}
    .segmented button.active{background:var(--text);color:var(--bg)}
    .segmented .warn{outline:2px solid var(--warn)}

    .slider-wrap{display:grid;gap:.35rem}
    input[type=range]{width:100%;accent-color:var(--text)}

    .checkgrid{display:grid;gap:.7rem;grid-template-columns:repeat(4,1fr)}
    .check{display:flex;align-items:center;gap:.5rem;padding:.6rem .7rem;border:1px solid var(--hair);border-radius:12px;background:var(--bg);cursor:pointer}

    textarea{width:100%;min-height:96px;resize:vertical;border-radius:16px;border:1px solid var(--hair);background:var(--bg);color:var(--text);padding:.8rem;font:inherit}

    .btn{display:inline-grid;place-items:center;width:100%;border:0;border-radius:16px;padding:1rem 1.1rem;font-weight:800;cursor:pointer;transition:transform .18s var(--easing),opacity .18s}
    .btn:active{transform:scale(.98)}
    .btn-primary{background:var(--text);color:var(--bg)}
    .btn-accent{background:var(--accent);color:#fff}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--hair)}
    .btn-sos{background:color-mix(in oklab,var(--accent-2) 18%,transparent);border:1px solid color-mix(in oklab,var(--accent-2) 35%,transparent);color:var(--text)}

    .note{font-size:.82rem;color:var(--sub);margin-top:.5rem}

    footer{padding:1.2rem;color:var(--sub);text-align:center}

    /* bottom bar for non-telegram */
    .bottomBar{position:sticky;bottom:0;left:0;right:0;background:var(--glass);border-top:1px solid var(--hair);backdrop-filter:saturate(140%) blur(18px);-webkit-backdrop-filter:saturate(140%) blur(18px);padding:.6rem .9rem;display:none}
    .bottomBar .btn{max-width:640px;margin:0 auto}

    .bigStat{font-size:2rem;font-weight:900}

    .pulse{animation:pulse 1.4s ease-in-out infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(255,159,10,.0)}50%{box-shadow:0 0 0 10px rgba(255,159,10,.12)}}

    @media (max-width:720px){ .row,.row-3{grid-template-columns:1fr} .checkgrid{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="title">OtkazAlcoFree</div>
        <div class="muted">–ú–∏–Ω–∏‚Äë–∞–ø–ø ‚Ä¢ iOS‚Äë26</div>
      </div>
      <button class="toggle" id="themeToggle" title="–¢–µ–º–∞">‚òæ</button>
    </header>

    <main>
      <section class="card" id="sobrietyCard">
        <div class="row">
          <div>
            <div class="label">–î–Ω–µ–π —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏</div>
            <div class="bigStat" id="daysSober">0</div>
            <div class="muted">—Å <span id="startDateLabel">‚Äî</span></div>
          </div>
          <div>
            <div class="label">–î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞</div>
            <div class="row">
              <input id="startDate" type="date" style="width:100%;padding:.8rem;border:1px solid var(--hair);border-radius:12px;background:var(--bg);color:var(--text)"/>
              <button class="btn btn-ghost" id="saveStart">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <p class="note">–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —á–µ—Ä–µ–∑ <code>?start=YYYY-MM-DD</code>.</p>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="row">
          <div>
            <div class="label">–°–µ–≥–æ–¥–Ω—è –ø–∏–ª?</div>
            <div class="segmented" id="drank">
              <button type="button" data-value="no" class="active">–ù–µ –ø–∏–ª</button>
              <button type="button" id="relapseBtn" data-value="relapse">–ë—ã–ª —Å—Ä—ã–≤</button>
            </div>
          </div>
          <div>
            <div class="label">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ <span id="moodEmoji">üòê</span></div>
            <div class="slider-wrap">
              <input id="mood" type="range" min="0" max="10" value="5" />
              <div class="muted">—É—Ä–æ–≤–µ–Ω—å: <span id="moodVal">5</span></div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:1rem">
          <div>
            <div class="label">–°–∏–ª–∞ —Ç—è–≥–∏ (0‚Äì10)</div>
            <div class="slider-wrap">
              <input id="craving" type="range" min="0" max="10" value="5" />
              <div class="muted">—É—Ä–æ–≤–µ–Ω—å: <span id="cravingVal">5</span></div>
            </div>
          </div>
          <div>
            <div class="label">–¢—Ä–∏–≥–≥–µ—Ä—ã</div>
            <div class="checkgrid">
              <label class="check"><input type="checkbox" value="–∫–æ–º–ø–∞–Ω–∏—è"/> üçª –∫–æ–º–ø–∞–Ω–∏—è</label>
              <label class="check"><input type="checkbox" value="—É—Å—Ç–∞–ª–æ—Å—Ç—å"/> üòÆ‚Äçüí® —É—Å—Ç–∞–ª–æ—Å—Ç—å</label>
              <label class="check"><input type="checkbox" value="—Å—Ç—Ä–µ—Å—Å"/> üòµ‚Äçüí´ —Å—Ç—Ä–µ—Å—Å</label>
              <label class="check"><input type="checkbox" value="—Å–∫—É–∫–∞"/> üò¥ —Å–∫—É–∫–∞</label>
              <label class="check"><input type="checkbox" value="–ø—Ä–∞–∑–¥–Ω–∏–∫"/> üéâ –ø—Ä–∞–∑–¥–Ω–∏–∫</label>
              <label class="check"><input type="checkbox" value="–∫–æ–Ω—Ñ–ª–∏–∫—Ç"/> ‚öîÔ∏è –∫–æ–Ω—Ñ–ª–∏–∫—Ç</label>
              <label class="check"><input type="checkbox" value="–æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ"/> ü´• –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ</label>
              <label class="check"><input type="checkbox" value="–∑–ª–æ—Å—Ç—å"/> üò° –∑–ª–æ—Å—Ç—å</label>
            </div>
          </div>
        </div>

        <div style="margin-top:1rem">
          <div class="label">–ó–∞–º–µ—Ç–∫–∞</div>
          <textarea id="note" placeholder="–ö–∞–∫ –ø—Ä–æ—à—ë–ª –¥–µ–Ω—å? –ß—Ç–æ –ø–æ–º–æ–≥–ª–æ –¥–µ—Ä–∂–∞—Ç—å—Å—è?"></textarea>
        </div>

        <div class="row" style="margin-top:1rem">
          <button class="btn btn-sos" id="sosBtn">SOS ‚Äî —Ç—è–≥–∞</button>
          <button class="btn btn-primary" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button>
        </div>

        <p class="note">–û—Ç—á—ë—Ç —É–ª–µ—Ç–∞–µ—Ç –∏ –≤ –≤–∞—à –±—ç–∫–µ–Ω–¥ (–µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω –≤–µ–±—Ö—É–∫), –∏ –≤ –±–æ—Ç–∞ –∫–∞–∫ <code>web_app_data</code>.</p>
      </section>

      <section class="card">
        <div class="label">Webhook (n8n / backend)</div>
        <div class="row">
          <input id="webhook" style="width:100%;padding:.8rem;border:1px solid var(--hair);border-radius:12px;background:var(--bg);color:var(--text)" value="https://dadkey.app.n8n.cloud/webhook/otkaz" />
          <button class="btn btn-ghost" id="saveHook">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <p class="note">–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —á–µ—Ä–µ–∑ <code>?webhook=...</code>. –°–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ <code>localStorage</code>.</p>
      </section>

      <footer>–ë–µ—Ä–µ–≥–∏ —Å–µ–±—è. –û–¥–∏–Ω –¥–µ–Ω—å ‚Äî –ø–æ–±–µ–¥–∞.</footer>
    </main>

    <div class="bottomBar" id="bottomBar"><button class="btn btn-accent" id="bottomSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button></div>
  </div>

  <script>
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    const body = document.body;
    const toggle = document.getElementById('themeToggle');
    const mood = document.getElementById('mood');
    const moodVal = document.getElementById('moodVal');
    const moodEmoji = document.getElementById('moodEmoji');
    const craving = document.getElementById('craving');
    const cravingVal = document.getElementById('cravingVal');
    const drank = document.getElementById('drank');
    const relapseBtn = document.getElementById('relapseBtn');
    const webhookInput = document.getElementById('webhook');
    const saveHookBtn = document.getElementById('saveHook');
    const sendBtn = document.getElementById('sendBtn');
    const bottomSend = document.getElementById('bottomSend');
    const sosBtn = document.getElementById('sosBtn');
    const bottomBar = document.getElementById('bottomBar');

    const startDate = document.getElementById('startDate');
    const saveStart = document.getElementById('saveStart');
    const startDateLabel = document.getElementById('startDateLabel');
    const daysSober = document.getElementById('daysSober');

    // Theme
    if (tg) { applyTgTheme(tg.colorScheme); tg.onEvent('themeChanged', () => applyTgTheme(tg.colorScheme)); tg.expand(); }
    else { const s = localStorage.getItem('theme'); if (s==='dark') body.classList.add('dark'); }
    toggle.textContent = body.classList.contains('dark') ? '‚òÄÔ∏é' : '‚òæ';
    toggle.addEventListener('click', ()=>{ body.classList.toggle('dark'); toggle.textContent = body.classList.contains('dark')?'‚òÄÔ∏é':'‚òæ'; if(!tg) localStorage.setItem('theme', body.classList.contains('dark')?'dark':'light'); });
    function applyTgTheme(s){ body.classList.toggle('dark', s==='dark'); toggle.textContent = s==='dark'?'‚òÄÔ∏é':'‚òæ'; }

    // Query params: webhook & start
    const qs = new URLSearchParams(location.search);
    const qsHook = qs.get('webhook');
    const qsStart = qs.get('start');

    // Stored config
    const storedHook = localStorage.getItem('otkaz_webhook');
    if (qsHook) webhookInput.value = qsHook; else if (storedHook) webhookInput.value = storedHook;
    saveHookBtn.addEventListener('click', ()=>{ localStorage.setItem('otkaz_webhook', webhookInput.value.trim()); toast('Webhook —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); });

    const storedStart = localStorage.getItem('otkaz_start');
    if (qsStart) startDate.value = qsStart; else if (storedStart) startDate.value = storedStart; else startDate.valueAsDate = new Date();
    renderSobriety();
    saveStart.addEventListener('click', ()=>{ localStorage.setItem('otkaz_start', startDate.value); renderSobriety(); toast('–°—Ç–∞—Ä—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); });

    function renderSobriety(){
      const v = startDate.value; startDateLabel.textContent = v || '‚Äî';
      const d0 = v ? new Date(v+'T00:00:00') : new Date();
      const now = new Date();
      const days = Math.max(0, Math.floor((now - d0)/86400000));
      daysSober.textContent = days.toString();
    }

    // Controls
    mood.addEventListener('input', ()=>{ moodVal.textContent = mood.value; moodEmoji.textContent = moodToEmoji(+mood.value); saveDraft();});
    craving.addEventListener('input', ()=>{ cravingVal.textContent = craving.value; cravingGuard(); saveDraft(); });
    drank.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{ drank.querySelectorAll('button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); saveDraft(); }));
    document.querySelectorAll('.check input').forEach(c=>c.addEventListener('change', saveDraft));
    document.getElementById('note').addEventListener('input', saveDraft);

    function moodToEmoji(v){
      if (v <= 2) return 'üò≠';
      if (v <= 4) return 'üòû';
      if (v <= 6) return 'üòê';
      if (v <= 8) return 'üôÇ';
      return 'üòÑ';
    }

    // Highlight relapse if craving high
    function cravingGuard(){
      const th = 8; // –ø–æ—Ä–æ–≥
      const high = (+craving.value >= th);
      relapseBtn.classList.toggle('warn', high);
      relapseBtn.classList.toggle('pulse', high);
    }
    cravingGuard();

    // Telegram MainButton
    if (tg && tg.MainButton) {
      tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç');
      tg.MainButton.onClick(()=> submit('report'));
      tg.MainButton.show();
    } else {
      bottomBar.style.display = 'block';
    }

    bottomSend.addEventListener('click', ()=> submit('report'));
    sendBtn.addEventListener('click', ()=> submit('report'));
    sosBtn.addEventListener('click', ()=> submit('sos_craving'));

    function collect(){
      const statusVal = drank.querySelector('.active')?.dataset.value || 'no';
      const checks = Array.from(document.querySelectorAll('.check input:checked')).map(i=>i.value);
      const note = document.getElementById('note').value.trim();
      return {
        day:{
          drank: statusVal !== 'no',
          status: statusVal === 'no' ? '–ù–µ –ø–∏–ª' : '–°—Ä—ã–≤',
          craving: Number(craving.value||0),
          mood: Number(mood.value||0),
          triggers: checks,
          note
        }
      };
    }

    async function submit(kind){
      const WEBHOOK_URL = (webhookInput.value||'').trim();
      if (!WEBHOOK_URL) { toast('–£–∫–∞–∂–∏ webhook'); return; }

      const base = collect();
      const meta = { kind, ts:new Date().toISOString(), ua:navigator.userAgent, ref:location.href };
      if (tg && tg.initDataUnsafe) { const u = tg.initDataUnsafe.user||{}; meta.tg = { id:u.id, username:u.username, first_name:u.first_name, last_name:u.last_name, theme: tg.colorScheme }; }

      const payload = { ...base, meta, start: startDate.value };

      try {
        const res = await fetch(WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), keepalive:true });
        if (!res.ok) throw new Error('HTTP '+res.status);
      } catch(e){ console.error(e); toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—å webhook'); return; }

      try { tg && tg.sendData && tg.sendData(JSON.stringify(payload)); } catch(e){}

      toast(kind==='sos_craving' ? 'üö® SOS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω' : '‚úÖ –û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      clearDraft();
    }

    // ===== –ß–µ—Ä–Ω–æ–≤–∏–∫ (autosave)
    const DRAFT_KEY = 'otkaz_draft_v1';
    function saveDraft(){
      const data = collect();
      localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
    }
    function loadDraft(){
      const raw = localStorage.getItem(DRAFT_KEY); if(!raw) return;
      try{
        const d = JSON.parse(raw);
        // status
        const isRelapse = d?.day?.status === '–°—Ä—ã–≤';
        drank.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
        (isRelapse ? relapseBtn : drank.querySelector('button[data-value="no"]')).classList.add('active');
        // sliders
        if (typeof d?.day?.craving === 'number'){ craving.value = d.day.craving; cravingVal.textContent = d.day.craving; }
        if (typeof d?.day?.mood === 'number'){ mood.value = d.day.mood; moodVal.textContent = d.day.mood; moodEmoji.textContent = moodToEmoji(d.day.mood); }
        // triggers
        const set = new Set(d?.day?.triggers || []);
        document.querySelectorAll('.check input').forEach(i=> i.checked = set.has(i.value));
        // note
        if (typeof d?.day?.note === 'string') document.getElementById('note').value = d.day.note;
        cravingGuard();
      }catch{}
    }
    function clearDraft(){ localStorage.removeItem(DRAFT_KEY); }
    loadDraft();

    // Toast
    function toast(text){
      const t=document.createElement('div'); t.textContent=text; Object.assign(t.style,{position:'fixed',left:'50%',bottom:'22px',transform:'translateX(-50%)',background:'var(--glass)',color:'var(--text)',border:'1px solid var(--hair)',padding:'.6rem .9rem',borderRadius:'999px',boxShadow:'var(--shadow)',zIndex:50,opacity:0,backdropFilter:'saturate(140%) blur(12px)'}); document.body.appendChild(t);
      t.animate([{transform:'translate(-50%,12px)',opacity:0},{transform:'translate(-50%,0)',opacity:1,offset:.2},{transform:'translate(-50%,0)',opacity:1,offset:.8},{transform:'translate(-50%,12px)',opacity:0}],{duration:1700,easing:'var(--easing)'}).onfinish=()=>t.remove();
    }
  </script>
</body>
</html>
